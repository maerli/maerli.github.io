<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>OpenCV.js</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.js"></script>
</head>
<body>
<script src="https://docs.opencv.org/3.3.1/opencv.js" type="text/javascript"></script>

<script type="text/javascript">

let img, canvas, mat, dst, circles, video, circlesList = []

function preload(){
	//img = loadImage("http://localhost:2000/download.jpg")
}
function setup(){
	canvas = createCanvas(400, 400)
	
	video = createCapture(VIDEO)
	video.size(200, 200)

}
function draw() {
	image(video, 0 , 0, width, height)
	
	circlesList.forEach(a=>{
		const [x,y,r] = a
		circle(x,y,r)
	})
	
}

function detect(){
	circles = new cv.Mat();
	mat = cv.imread(canvas.canvas)
	dst = mat.clone()
	cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY, 0);
	
	cv.HoughCircles(mat, circles, cv.HOUGH_GRADIENT,
                1 , 45, 75, 40, 0, 0);
	for (let i = 0; i < circles.cols; ++i) {
    	let x = circles.data32F[i * 3];
    	let y = circles.data32F[i * 3 + 1];
    	let radius = circles.data32F[i * 3 + 2];
    	let center = new cv.Point(x, y);

    	
    	
    	let chunck = get(center.x-5, center.y-5, 10, 10 )
    	chunck.loadPixels()
    	p = chunck.pixels

    	let sum = 0

    	for(let c = 0; c < 100; c++){
    		let r = p[c]
    		let g = p[c + 1]
    		let b = p[c + 2]
    		let _ = p[c + 3]
    		
    		sum += r + g + b


    	}
    	
    	if(sum/300 < 65){
    		fill(255,0,255)
    	netflix:///app?source_type=1
    	//rect(center.x, center.y, 10,10)
    		text(sum/300, center.x, center.y)
    	}

    	circlesList.push([center.x, center.y, radius])
	}
	console.log(circles.cols)
	
	
	mat.delete();
	dst.delete();
	circles.delete();


}

</script>
<button onclick="detect()"> Detect </button>
</body>
</html>
